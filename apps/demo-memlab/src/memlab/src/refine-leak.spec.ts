import { LeakItem } from './leak-item.interface';
import { refineLeak } from './refine-leak';

describe('refine-leak.ts', () => {
  const sourceLeakTrace = `[<synthetic>] (synthetic) @1 [7.6MB]\n  --2 (shortcut)--->  [Window / http://localhost:4200] (object) @6201 [87.4KB]\n  --$localize (property)--->  [<closure>] (closure) @94417 [76 bytes]\n  --context (internal)--->  [<function scope>] (object) @44465 [134.7KB]\n  --TRACKED_LVIEWS (variable)--->  [Map] (object) @115001 [260 bytes]\n  --table (internal)--->  [<array>] (array) @319429 [244 bytes]\n  --15 (internal)--->  [Array] (object) @165445 [3.7KB]\n  --11 (element)--->  [BaseAnimationRenderer] (object) @169033 [120 bytes]\n  --engine (property)--->  [_InjectableAnimationEngine] (object) @168773 [25.7KB]\n  --_transitionEngine (property)--->  [TransitionAnimationEngine] (object) @218467 [17.5KB]\n  --_whenQuietFns (property)--->  [Array] (object) @319929 [712 bytes]\n  --1 (element)--->  [<closure>] (closure) @321575 [416 bytes]\n  --context (internal)--->  [<function scope>] (object) @321637 [388 bytes]\n  --this (variable)--->  [AnimationTransitionNamespace] (object) @303415 [344 bytes]\n  --hostElement (property)--->  [Detached HTMLElement] (native) @299065 [3.5KB]\n  --13 (element)--->  [Detached HTMLDivElement] (native) @299051 [2.7KB]\n  --8 (element)--->  [Detached HTMLDivElement] (native) @298989 [1.7KB]\n  --3 (element)--->  [Detached HTMLDivElement] (native) @298985 [1.4KB]\n  --3 (element)--->  [Detached SVGSVGElement] (native) @298981 [1.2KB]\n  --6 (element)--->  [Detached SVGAnimatedLength] (native) @4088 [64 bytes]\n`;
  const foundLeaks: LeakItem[] = [];
  describe('when the destination leak trace has two traces that are similar', () => {
    describe('but one is slightly different from the source leak trace', () => {
      beforeEach(() => {
        foundLeaks.push({
          leakTraceSummary: `[<synthetic>] (synthetic) @1 [17.16MB]\n  --3 (shortcut)--->  [Window / http://localhost:4200] (object) @62101 [817.4KB]\n  --$localize (property)--->  [<closure>] (closure) @941417 [716 bytes]\n  --context (internal)--->  [<function scope>] (object) @444165 [1314.71KB]\n  --TRACKED_LVIEWS (variable)--->  [Map] (object) @1115001 [2160 bytes]\n  --table (internal)--->  [<array>] (array) @3119429 [2144 bytes]\n  --115 (internal)--->  [Array] (object) @1615445 [3.71KB]\n  --121 (element)--->  [BaseAnimationRenderer] (object) @1692033 [1220 bytes]\n  --engine (property)--->  [_InjectableAnimationEngine] (object) @1268773 [225.17KB]\n  --_transitionEngine (property)--->  [TransitionAnimationEngine] (object) @2118467 [117.25KB]\n  --_whenQuietFns (property)--->  [Array] (object) @3199129 [7112 bytes]\n  --11 (element)--->  [<closure>] (closure) @3121575 [4116 bytes]\n  --context (internal)--->  [<function scope>] (object) @3121637 [3881 bytes]\n  --this (variable)--->  [AnimationTransitionNamespace] (object) @3032415 [3244 bytes]\n  --hostElement (property)--->  [Detached HTMLElement] (native) @299065 [13.15KB]\n  --113 (element)--->  [Detached HTMLDivElement] (native) @299051 [21.17KB]\n  --81 (element)--->  [Detached HTMLDivElement] (native) @2198989 [11.7KB]\n  --13 (element)--->  [Detached HTMLDivElement] (native) @2981985 [11.14KB]\n  --13 (element)--->  [Detached SVGSVGElement] (native) @2198981 [11.12KB]\n  --61 (element)--->  [Detached SVGAnimatedLength] (native) @40188 [614 bytes]\n`,
          numDuplicates: 96,
        });
        foundLeaks.push({
          leakTraceSummary: `[<synthetic>] (synthetic) @1 [7.6MB]\n  --2 (shortcut)--->  [Window / http://localhost:4200] (object) @6201 [87.4KB]\n  --$localize (property)--->  [<closure>] (closure) @94417 [76 bytes]\n  --context (internal)--->  [<function scope>] (object) @44465 [134.7KB]\n  --TRACKED_LVIEWS (variable)--->  [Map] (object) @115001 [260 bytes]\n  --table (internal)--->  [<array>] (array) @319429 [244 bytes]\n  --15 (internal)--->  [Array] (object) @165445 [3.7KB]\n  --11 (element)--->  [BaseAnimationRenderer] (object) @169033 [120 bytes]\n  --engine (property)--->  [_InjectableAnimationEngine] (object) @168773 [25.7KB]\n  --_transitionEngine (property)--->  [TransitionAnimationEngine] (object) @218467 [17.5KB]\n  --_whenQuietFns (property)--->  [Array] (object) @319929 [712 bytes]\n  --1 (element)--->  [<closure>] (closure) @321575 [416 bytes]\n  --context (internal)--->  [<function scope>] (object) @321637 [388 bytes]\n  --this (variable)--->  [AnimationTransitionNamespace] (object) @303415 [344 bytes]\n  --hostElement (property)--->  [Detached HTMLElement] (native) @299065 [3.5KB]\n  --13 (element)--->  [Detached HTMLDivElement] (native) @299051 [2.7KB]\n  --8 (element)--->  [Detached HTMLDivElement] (native) @298989 [1.7KB]\n  --3 (element)--->  [Detached HTMLDivElement] (native) @298985 [1.4KB]\n  --3 (element)--->  [Detached SVGxxxSVGElement] (native) @298981 [1.2KB]\n  --6 (element)--->  [Detached SVGAnimatedLength] (native) @4088 [64 bytes]\n`,
          numDuplicates: 97,
        });
      });
      it('should return the trace that is most similar to the source leak trace', () => {
        expect(refineLeak(sourceLeakTrace, foundLeaks)?.numDuplicates).toBe(96);
      });
    });
  });
});
